<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0f">
    <title>Wordly</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --bg2: #12121a;
            --card: linear-gradient(145deg, #1a1a2e, #16162a);
            --gold: #d4a574;
            --purple: #7c6aef;
            --text: #f5f5f7;
            --muted: #606070;
            --green: #4ade80;
            --red: #f87171;
            --glass: rgba(255,255,255,0.03);
            --border: rgba(255,255,255,0.08);
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html,body { overscroll-behavior:none; }
        body {
            font-family: 'Manrope', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100dvh;
            letter-spacing: -0.01em;
        }
        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }
        .orb1 { width:300px; height:300px; background:var(--purple); top:-100px; right:-100px; }
        .orb2 { width:250px; height:250px; background:var(--gold); bottom:20%; left:-80px; }
        
        .app {
            position: relative;
            z-index: 1;
            padding: 16px;
            padding-top: calc(12px + env(safe-area-inset-top));
            padding-bottom: 70px;
            min-height: 100dvh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .page-title {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.03em;
        }
        .profile-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gold), var(--purple));
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .profile-btn:active { transform: scale(0.95); }
        
        /* Flashcard - –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω */
        .card-wrap { perspective:1000px; margin-bottom:20px; }
        .card {
            width: 100%;
            height: 340px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .card.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }
        .card-front {
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .card-back {
            background: linear-gradient(145deg, #1e1e3a, #1a1a35);
            border: 1px solid var(--purple);
            transform: rotateY(180deg);
        }
        .card-cat { font-size:11px; text-transform:uppercase; letter-spacing:1.5px; color:var(--gold); margin-bottom:20px; font-weight:600; }
        .card-word { font-size:36px; font-weight:700; margin-bottom:12px; }
        .card-phon { font-size:16px; color:var(--muted); font-style:italic; }
        .card-trans { font-size:32px; font-weight:600; margin-bottom:16px; }
        .card-ex { font-size:15px; color:#a0a0b0; max-width:280px; }
        .card-ex em { color:#9d8ff5; font-style:normal; font-weight:500; }
        .tap-hint { position:absolute; bottom:20px; font-size:12px; color:var(--muted); }
        
        /* Buttons */
        .btns { display:flex; justify-content:center; gap:16px; }
        .btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            transition: transform 0.2s;
        }
        .btn:active { transform:scale(0.9); }
        .btn-no { background:linear-gradient(135deg, #2a1a1a, #1a0a0a); border:2px solid var(--red); color:var(--red); }
        .btn-yes { background:linear-gradient(135deg, #1a2a1a, #0a1a0a); border:2px solid var(--green); color:var(--green); }
        .btn-skip { width:48px; height:48px; background:var(--glass); border:1px solid var(--border); color:var(--muted); font-size:18px; align-self:center; }

        /* Counter on home */
        .home-counter {
            text-align: center;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--muted);
        }
        .home-counter b { color: var(--gold); font-weight: 700; }

        /* Mode switcher */
        .mode-switch {
            display: flex;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 16px;
        }
        .mode-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--muted);
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn.on {
            background: linear-gradient(135deg, var(--gold), var(--purple));
            color: white;
        }

        /* ===== PROGRESS VIEW ===== */
        .progress-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .progress-title { font-size: 15px; color: var(--muted); }
        .progress-val { font-size: 28px; font-weight: 800; }
        .progress-val.gold { color: var(--gold); }
        .progress-bar { height:10px; background:var(--bg2); border-radius:5px; overflow:hidden; }
        .progress-fill { height:100%; background:linear-gradient(90deg, var(--gold), var(--purple)); border-radius:5px; transition:width 0.8s; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .stat-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }
        .stat-val { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
        .stat-val.green { color: var(--green); }
        .stat-val.purple { color: var(--purple); }
        .stat-val.blue { color: #60a5fa; }
        .stat-val.gold { color: var(--gold); }
        .stat-lbl { font-size: 12px; color: var(--muted); }

        .streak-card {
            background: linear-gradient(135deg, rgba(212,165,116,0.15), rgba(124,106,239,0.15));
            border: 1px solid var(--gold);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        .streak-icon { font-size: 36px; }
        .streak-info h3 { font-size: 22px; font-weight: 800; color: var(--gold); }
        .streak-info span { font-size: 13px; color: var(--muted); }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .week-chart {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 90px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
        }
        .week-day { display:flex; flex-direction:column; align-items:center; gap:6px; flex:1; }
        .week-bar-wrap { width:100%; max-width:20px; height:45px; background:var(--bg2); border-radius:4px; display:flex; align-items:flex-end; overflow:hidden; }
        .week-bar { width:100%; background:linear-gradient(180deg, var(--purple), var(--gold)); border-radius:4px; min-height:2px; }
        .week-bar.today { background:linear-gradient(180deg, var(--green), #22c55e); }
        .week-lbl { font-size:10px; color:var(--muted); }
        .week-lbl.today { color:var(--green); font-weight:600; }

        /* ===== DECKS ===== */
        .decks { display:flex; flex-direction:column; gap:10px; }
        .deck {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .deck:active { transform:scale(0.98); }
        .deck-icon { width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; }
        .deck-icon.basic { background:linear-gradient(135deg, #4ade80, #22c55e); }
        .deck-icon.inter { background:linear-gradient(135deg, #60a5fa, #3b82f6); }
        .deck-icon.adv { background:linear-gradient(135deg, #f472b6, #ec4899); }
        .deck-icon.idiom { background:linear-gradient(135deg, #fbbf24, #f59e0b); }
        .deck-info { flex:1; }
        .deck-name { font-size:16px; font-weight:600; margin-bottom:2px; }
        .deck-meta { font-size:12px; color:var(--muted); }
        .deck-arr { font-size:18px; color:var(--muted); }
        
        .detail-head { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
        .back-btn { width:36px; height:36px; border-radius:10px; background:var(--glass); border:1px solid var(--border); color:var(--text); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .detail-title { font-size:20px; font-weight:700; }
        
        .words { display:flex; flex-direction:column; gap:8px; }
        .word-item { background:var(--glass); border:1px solid var(--border); border-radius:14px; padding:14px; display:flex; justify-content:space-between; align-items:center; }
        .word-w { font-size:16px; font-weight:600; margin-bottom:2px; }
        .word-t { font-size:13px; color:var(--muted); }
        .word-status { width:8px; height:8px; border-radius:50%; background:var(--muted); }
        .word-status.learned { background:var(--green); }
        .word-status.learning { background:var(--purple); }
        
        .study-btn { width:100%; padding:14px; background:linear-gradient(135deg, var(--gold), var(--purple)); border:none; border-radius:14px; color:white; font-size:15px; font-weight:600; font-family:inherit; cursor:pointer; margin-top:16px; }

        /* ===== ADD FORM ===== */
        .form-group { margin-bottom:14px; }
        .form-lbl { display:block; font-size:11px; color:var(--muted); text-transform:uppercase; margin-bottom:6px; }
        .form-input { width:100%; padding:12px 14px; background:var(--bg2); border:1px solid var(--border); border-radius:12px; color:var(--text); font-size:15px; font-family:inherit; }
        .form-input:focus { outline:none; border-color:var(--purple); }
        .form-input::placeholder { color:var(--muted); }
        .submit-btn { width:100%; padding:14px; background:linear-gradient(135deg, var(--gold), var(--purple)); border:none; border-radius:12px; color:white; font-size:15px; font-weight:600; font-family:inherit; cursor:pointer; }

        /* ===== SETTINGS ===== */
        .section { background:var(--glass); border:1px solid var(--border); border-radius:16px; padding:14px; margin-bottom:12px; }
        .section-head { font-size:14px; font-weight:600; margin-bottom:12px; color:#a0a0b0; }
        .row { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border); }
        .row:last-child { border-bottom:none; }
        .row span { font-size:14px; }
        .toggle { width:46px; height:26px; background:var(--bg2); border-radius:13px; position:relative; cursor:pointer; }
        .toggle.on { background:var(--purple); }
        .toggle::after { content:''; position:absolute; width:20px; height:20px; background:white; border-radius:50%; top:3px; left:3px; transition:transform 0.3s; }
        .toggle.on::after { transform:translateX(20px); }
        .cnt-btn { padding:6px 12px; background:var(--bg2); border:1px solid var(--border); border-radius:8px; color:#a0a0b0; font-size:13px; font-family:inherit; cursor:pointer; }
        .cnt-btn.on { background:var(--gold); border-color:var(--gold); color:var(--bg); font-weight:600; }
        .cnt-btn.danger { border-color:var(--red); color:var(--red); }
        .cnt-sel { display:flex; gap:6px; }

        /* ===== NAV - COMPACT ===== */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10,10,15,0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 6px 8px;
            padding-bottom: calc(6px + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 10px;
            border-radius: 10px;
            background: none;
            border: none;
            color: var(--muted);
            font-family: inherit;
            cursor: pointer;
        }
        .nav-item.on { color: var(--gold); }
        .nav-icon { font-size: 20px; }
        .nav-lbl { font-size: 9px; font-weight: 500; }
        
        .view { display:none; }
        .view.on { display:block; }
        
        .toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--bg2); border:1px solid var(--border); padding:12px 20px; border-radius:12px; font-size:13px; font-weight:500; opacity:0; transition:all 0.4s; z-index:1000; }
        .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
        .toast.ok { border-color:var(--green); color:var(--green); }
        .toast.err { border-color:var(--red); color:var(--red); }
        
        .empty { text-align:center; padding:40px 20px; }
        .empty-icon { font-size:48px; margin-bottom:12px; }
        .empty-text { font-size:16px; font-weight:600; margin-bottom:6px; }
        .empty-sub { font-size:13px; color:var(--muted); }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; display:none; align-items:center; justify-content:center; padding:20px; }
        .modal-overlay.show { display:flex; }
        .modal { background:var(--bg2); border-radius:20px; padding:24px; width:100%; max-width:360px; border:1px solid var(--border); }
        .modal-title { font-size:18px; font-weight:700; margin-bottom:20px; text-align:center; }
        .modal .form-group { margin-bottom:14px; }
        .modal .form-lbl { font-size:12px; color:var(--muted); margin-bottom:6px; display:block; }
        .modal .form-input { width:100%; background:var(--glass); border:1px solid var(--border); border-radius:10px; padding:12px; color:var(--text); font-size:14px; }
        .modal-btns { display:flex; gap:10px; margin-top:20px; }
        .modal-btn { flex:1; padding:12px; border-radius:12px; border:none; font-size:14px; font-weight:600; cursor:pointer; }
        .modal-btn.save { background:var(--green); color:#000; }
        .modal-btn.cancel { background:var(--glass); color:var(--text); border:1px solid var(--border); }
        .modal-btn.delete { background:var(--red); color:#fff; }
        .modal-btn:active { transform:scale(0.97); }
        
        .word-item { cursor:pointer; transition: background 0.2s; }
        .word-item:active { background:var(--glass); }
        
        @media (max-width:380px) {
            .card-word { font-size:28px; }
            .card-trans { font-size:24px; }
            .card { height:300px; }
            .btn { width:56px; height:56px; font-size:22px; }
        }
    </style>
</head>
<body>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    
    <div class="app">
        <!-- HOME - —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div id="v-home" class="view on">
            <div class="header">
                <span class="page-title">–£—á–∏—Ç—å</span>
                <button class="profile-btn" id="open-profile">üë§</button>
            </div>
            
            <div class="home-counter">–û—Å—Ç–∞–ª–æ—Å—å: <b id="remaining">0</b> —Å–ª–æ–≤</div>
            
            <div class="mode-switch">
                <button class="mode-btn on" id="mode-learn">üìö –£—á–∏—Ç—å</button>
                <button class="mode-btn" id="mode-repeat">üîÑ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</button>
            </div>
            
            <div class="card-wrap">
                <div class="card" id="card">
                    <div class="card-face card-front">
                        <div class="card-cat" id="c-cat">‚Äî</div>
                        <div class="card-word" id="c-word">–î–æ–±–∞–≤—å —Å–ª–æ–≤–∞</div>
                        <div class="card-phon" id="c-phon"></div>
                        <div class="tap-hint">üëÜ –ù–∞–∂–º–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</div>
                    </div>
                    <div class="card-face card-back">
                        <div class="card-cat">–ü–µ—Ä–µ–≤–æ–¥</div>
                        <div class="card-trans" id="c-trans">‚Äî</div>
                        <div class="card-ex" id="c-ex"></div>
                    </div>
                </div>
            </div>
            
            <div class="btns">
                <button class="btn btn-no" id="b-no">‚úï</button>
                <button class="btn btn-skip" id="b-skip">‚Ü∑</button>
                <button class="btn btn-yes" id="b-yes">‚úì</button>
            </div>
        </div>
        
        <!-- PROGRESS - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="v-progress" class="view">
            <div class="header">
                <span class="page-title">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                <button class="profile-btn" id="open-profile-2">üë§</button>
            </div>
            
            <div class="streak-card">
                <div class="streak-icon">üî•</div>
                <div class="streak-info">
                    <h3 id="p-streak">0 –¥–Ω–µ–π</h3>
                    <span>–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è</span>
                </div>
            </div>
            
            <div class="progress-card">
                <div class="progress-header">
                    <span class="progress-title">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span class="progress-val gold" id="p-pct">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="p-fill" style="width:0%"></div></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-val gold" id="p-total">0</div>
                    <div class="stat-lbl">–í—Å–µ–≥–æ —Å–ª–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val green" id="p-learned">0</div>
                    <div class="stat-lbl">–í—ã—É—á–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val purple" id="p-today">0</div>
                    <div class="stat-lbl">–°–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val blue" id="p-avg">0</div>
                    <div class="stat-lbl">–í —Å—Ä–µ–¥–Ω–µ–º/–¥–µ–Ω—å</div>
                </div>
            </div>
            
            <div class="section-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            <div class="week-chart" id="week-chart"></div>
        </div>
        
        <!-- DECKS -->
        <div id="v-decks" class="view">
            <div class="header">
                <span class="page-title">–ö–æ–ª–æ–¥—ã</span>
                <button class="profile-btn" id="open-profile-3">üë§</button>
            </div>
            <div id="decks-list"><div class="decks" id="decks"></div></div>
            <div id="deck-detail" style="display:none">
                <div class="detail-head">
                    <button class="back-btn" id="back">‚Üê</button>
                    <span class="detail-title" id="d-title">–ö–æ–ª–æ–¥–∞</span>
                </div>
                <div class="words" id="words"></div>
                <button class="study-btn" id="study">üìñ –£—á–∏—Ç—å —ç—Ç—É –∫–æ–ª–æ–¥—É</button>
            </div>
        </div>
        
        <!-- ADD -->
        <div id="v-add" class="view">
            <div class="header">
                <span class="page-title">–î–æ–±–∞–≤–∏—Ç—å</span>
                <button class="profile-btn" id="open-profile-4">üë§</button>
            </div>
            <div class="form-group"><label class="form-lbl">–°–ª–æ–≤–æ</label><input class="form-input" id="i-word" placeholder="example"></div>
            <div class="form-group"><label class="form-lbl">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</label><input class="form-input" id="i-phon" placeholder="/…™…°Ààz√¶mp…ôl/"></div>
            <div class="form-group"><label class="form-lbl">–ü–µ—Ä–µ–≤–æ–¥</label><input class="form-input" id="i-trans" placeholder="–ø—Ä–∏–º–µ—Ä"></div>
            <div class="form-group"><label class="form-lbl">–ü—Ä–∏–º–µ—Ä</label><input class="form-input" id="i-ex" placeholder="This is an example."></div>
            <div class="form-group">
                <label class="form-lbl">–ö–æ–ª–æ–¥–∞</label>
                <select class="form-input" id="i-deck">
                    <option value="basic">üìó –ë–∞–∑–æ–≤—ã–µ</option>
                    <option value="intermediate">üìò –°—Ä–µ–¥–Ω–∏–µ</option>
                    <option value="advanced">üìï –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ</option>
                    <option value="idioms">üìô –ò–¥–∏–æ–º—ã</option>
                </select>
            </div>
            <button class="submit-btn" id="add-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        
        <!-- SETTINGS -->
        <div id="v-settings" class="view">
            <div class="header">
                <span class="page-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                <button class="profile-btn" id="open-profile-5">üë§</button>
            </div>
            <div class="section">
                <div class="section-head">–û–±—É—á–µ–Ω–∏–µ</div>
                <div class="row"><span>–ö–∞—Ä—Ç–æ—á–µ–∫ –≤ –¥–µ–Ω—å</span><div class="cnt-sel"><button class="cnt-btn" data-n="10">10</button><button class="cnt-btn on" data-n="20">20</button><button class="cnt-btn" data-n="30">30</button></div></div>
                <div class="row"><span>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</span><div class="toggle on" id="t-phon"></div></div>
                <div class="row"><span>–ü—Ä–∏–º–µ—Ä—ã</span><div class="toggle on" id="t-ex"></div></div>
            </div>
            <div class="section">
                <div class="section-head">–î–∞–Ω–Ω—ã–µ</div>
                <div class="row"><span>–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</span><button class="cnt-btn" id="sync-up">‚òÅÔ∏è ‚Üë</button></div>
                <div class="row"><span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</span><button class="cnt-btn" id="sync-down">‚òÅÔ∏è ‚Üì</button></div>
                <div class="row"><span>–ò–º–ø–æ—Ä—Ç</span><button class="cnt-btn" id="import">üì•</button><input type="file" id="import-file" accept=".json" style="display:none"></div>
                <div class="row"><span>–≠–∫—Å–ø–æ—Ä—Ç</span><button class="cnt-btn" id="export">üì§</button></div>
                <div class="row"><span>–°–±—Ä–æ—Å</span><button class="cnt-btn danger" id="reset">üóë</button></div>
            </div>
            <div class="section">
                <div class="section-head">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
                <div class="row"><span>–ù–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</span><button class="cnt-btn" id="add-home">üì≤ –î–æ–±–∞–≤–∏—Ç—å</button></div>
            </div>
        </div>
    </div>
    
    <nav class="nav">
        <button class="nav-item on" data-v="home"><span class="nav-icon">üé¥</span><span class="nav-lbl">–£—á–∏—Ç—å</span></button>
        <button class="nav-item" data-v="progress"><span class="nav-icon">üìä</span><span class="nav-lbl">–ü—Ä–æ–≥—Ä–µ—Å—Å</span></button>
        <button class="nav-item" data-v="decks"><span class="nav-icon">üìÇ</span><span class="nav-lbl">–ö–æ–ª–æ–¥—ã</span></button>
        <button class="nav-item" data-v="add"><span class="nav-icon">‚ûï</span><span class="nav-lbl">–î–æ–±–∞–≤–∏—Ç—å</span></button>
        <button class="nav-item" data-v="settings"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-lbl">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
    </nav>
    
    <div class="toast" id="toast"></div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ–≤–∞ -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal">
            <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
            <div class="form-group"><label class="form-lbl">–°–ª–æ–≤–æ</label><input class="form-input" id="e-word"></div>
            <div class="form-group"><label class="form-lbl">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</label><input class="form-input" id="e-phon"></div>
            <div class="form-group"><label class="form-lbl">–ü–µ—Ä–µ–≤–æ–¥</label><input class="form-input" id="e-trans"></div>
            <div class="form-group"><label class="form-lbl">–ü—Ä–∏–º–µ—Ä</label><input class="form-input" id="e-ex"></div>
            <div class="form-group">
                <label class="form-lbl">–ö–æ–ª–æ–¥–∞</label>
                <select class="form-input" id="e-deck">
                    <option value="basic">üìó –ë–∞–∑–æ–≤—ã–µ</option>
                    <option value="intermediate">üìò –°—Ä–µ–¥–Ω–∏–µ</option>
                    <option value="advanced">üìï –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ</option>
                    <option value="idioms">üìô –ò–¥–∏–æ–º—ã</option>
                </select>
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" id="edit-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn delete" id="edit-delete">üóë</button>
                <button class="modal-btn save" id="edit-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script>
    const tg = window.Telegram?.WebApp;
    if(tg){ tg.ready(); tg.expand(); tg.setHeaderColor('#0a0a0f'); tg.setBackgroundColor('#0a0a0f'); tg.disableVerticalSwipes?.(); }
    const haptic = t => { if(!tg?.HapticFeedback)return; t==='ok'?tg.HapticFeedback.notificationOccurred('success'):t==='err'?tg.HapticFeedback.notificationOccurred('error'):tg.HapticFeedback.impactOccurred('light'); };
    
    // –•—Ä–∞–Ω–∏–ª–∏—â–∞ Telegram (CloudStorage –∏–ª–∏ DeviceStorage)
    const cloud = tg?.CloudStorage;
    const device = tg?.DeviceStorage;
    
    const S = {
        words: [],
        idx: 0,
        deck: null,
        streak: 0,
        today: 0,
        startDate: null,
        dailyStats: {},
        mode: 'learn', // 'learn' –∏–ª–∏ 'repeat'
        decks: {
            basic: {name:'–ë–∞–∑–æ–≤—ã–µ', icon:'üìó', cls:'basic'},
            intermediate: {name:'–°—Ä–µ–¥–Ω–∏–µ', icon:'üìò', cls:'inter'},
            advanced: {name:'–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ', icon:'üìï', cls:'adv'},
            idioms: {name:'–ò–¥–∏–æ–º—ã', icon:'üìô', cls:'idiom'}
        }
    };
    
    const samples = [
        // Basic Verbs
        {word:'have', trans:'–∏–º–µ—Ç—å', ex:'I <em>have</em> a car.', deck:'basic', learned:false, rev:0},
        {word:'want', trans:'—Ö–æ—Ç–µ—Ç—å', ex:'I <em>want</em> coffee.', deck:'basic', learned:false, rev:0},
        {word:'know', trans:'–∑–Ω–∞—Ç—å', ex:'I <em>know</em> the answer.', deck:'basic', learned:false, rev:0},
        {word:'do', trans:'–¥–µ–ª–∞—Ç—å', ex:'What do you <em>do</em>?', deck:'basic', learned:false, rev:0},
        {word:'make', trans:'–¥–µ–ª–∞—Ç—å, —Å–æ–∑–¥–∞–≤–∞—Ç—å', ex:'Let\'s <em>make</em> a cake.', deck:'basic', learned:false, rev:0},
        {word:'take', trans:'–±—Ä–∞—Ç—å', ex:'<em>Take</em> my hand.', deck:'basic', learned:false, rev:0},
        {word:'can', trans:'–º–æ—á—å', ex:'I <em>can</em> swim.', deck:'basic', learned:false, rev:0},
        {word:'work', trans:'—Ä–∞–±–æ—Ç–∞—Ç—å', ex:'I <em>work</em> from home.', deck:'basic', learned:false, rev:0},
        {word:'buy', trans:'–∫—É–ø–∏—Ç—å', ex:'I want to <em>buy</em> a phone.', deck:'basic', learned:false, rev:0},
        {word:'get', trans:'–ø–æ–ª—É—á–∞—Ç—å', ex:'Did you <em>get</em> my message?', deck:'basic', learned:false, rev:0},
        {word:'use', trans:'–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å', ex:'Can I <em>use</em> your pen?', deck:'basic', learned:false, rev:0},
        {word:'go', trans:'–∏–¥—Ç–∏', ex:'Let\'s <em>go</em> home.', deck:'basic', learned:false, rev:0},
        {word:'come', trans:'–ø—Ä–∏—Ö–æ–¥–∏—Ç—å', ex:'Please <em>come</em> here.', deck:'basic', learned:false, rev:0},
        {word:'leave', trans:'—É—Ö–æ–¥–∏—Ç—å, –æ—Å—Ç–∞–≤–ª—è—Ç—å', ex:'I have to <em>leave</em> now.', deck:'basic', learned:false, rev:0},
        {word:'stop', trans:'–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è', ex:'<em>Stop</em> the car!', deck:'basic', learned:false, rev:0},
        {word:'understand', trans:'–ø–æ–Ω–∏–º–∞—Ç—å', ex:'I don\'t <em>understand</em>.', deck:'basic', learned:false, rev:0},
        {word:'speak', trans:'–≥–æ–≤–æ—Ä–∏—Ç—å', ex:'Do you <em>speak</em> English?', deck:'basic', learned:false, rev:0},
        {word:'say', trans:'—Å–∫–∞–∑–∞—Ç—å', ex:'What did you <em>say</em>?', deck:'basic', learned:false, rev:0},
        {word:'ask', trans:'—Å–ø—Ä–∞—à–∏–≤–∞—Ç—å, –ø—Ä–æ—Å–∏—Ç—å', ex:'Can I <em>ask</em> a question?', deck:'basic', learned:false, rev:0},
        {word:'eat', trans:'–µ—Å—Ç—å, –∫—É—à–∞—Ç—å', ex:'Let\'s <em>eat</em> lunch.', deck:'basic', learned:false, rev:0},
        {word:'drink', trans:'–ø–∏—Ç—å', ex:'I <em>drink</em> tea every day.', deck:'basic', learned:false, rev:0},
        {word:'see', trans:'–≤–∏–¥–µ—Ç—å', ex:'I can <em>see</em> the mountain.', deck:'basic', learned:false, rev:0},
        {word:'look', trans:'—Å–º–æ—Ç—Ä–µ—Ç—å', ex:'<em>Look</em> at this!', deck:'basic', learned:false, rev:0},
        {word:'show', trans:'–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å', ex:'<em>Show</em> me the way.', deck:'basic', learned:false, rev:0},
        {word:'like', trans:'–Ω—Ä–∞–≤–∏—Ç—å—Å—è', ex:'I <em>like</em> pizza.', deck:'basic', learned:false, rev:0},
        {word:'remember', trans:'–ø–æ–º–Ω–∏—Ç—å', ex:'I <em>remember</em> you.', deck:'basic', learned:false, rev:0},
        {word:'forget', trans:'–∑–∞–±—ã–≤–∞—Ç—å', ex:'Don\'t <em>forget</em> your keys.', deck:'basic', learned:false, rev:0},
        {word:'read', trans:'—á–∏—Ç–∞—Ç—å', ex:'I <em>read</em> books every night.', deck:'basic', learned:false, rev:0},
        {word:'write', trans:'–ø–∏—Å–∞—Ç—å', ex:'Please <em>write</em> your name.', deck:'basic', learned:false, rev:0},
        {word:'keep', trans:'–¥–µ—Ä–∂–∞—Ç—å, —Ö—Ä–∞–Ω–∏—Ç—å', ex:'<em>Keep</em> it safe.', deck:'basic', learned:false, rev:0},
        {word:'stay', trans:'–æ—Å—Ç–∞–≤–∞—Ç—å—Å—è', ex:'<em>Stay</em> here with me.', deck:'basic', learned:false, rev:0},
        // Questions
        {word:'who', trans:'–∫—Ç–æ', ex:'<em>Who</em> is that?', deck:'basic', learned:false, rev:0},
        {word:'what', trans:'—á—Ç–æ', ex:'<em>What</em> is your name?', deck:'basic', learned:false, rev:0},
        {word:'where', trans:'–≥–¥–µ', ex:'<em>Where</em> do you live?', deck:'basic', learned:false, rev:0},
        {word:'when', trans:'–∫–æ–≥–¥–∞', ex:'<em>When</em> is your birthday?', deck:'basic', learned:false, rev:0},
        {word:'which', trans:'–∫–æ—Ç–æ—Ä—ã–π', ex:'<em>Which</em> one do you want?', deck:'basic', learned:false, rev:0},
        {word:'whose', trans:'—á–µ–π', ex:'<em>Whose</em> bag is this?', deck:'basic', learned:false, rev:0},
        {word:'why', trans:'–ø–æ—á–µ–º—É', ex:'<em>Why</em> are you late?', deck:'basic', learned:false, rev:0},
        {word:'how', trans:'–∫–∞–∫', ex:'<em>How</em> are you?', deck:'basic', learned:false, rev:0},
        {word:'what time', trans:'–≤–æ —Å–∫–æ–ª—å–∫–æ', ex:'<em>What time</em> is it?', deck:'intermediate', learned:false, rev:0},
        {word:'how long', trans:'–∫–∞–∫ –¥–æ–ª–≥–æ', ex:'<em>How long</em> does it take?', deck:'intermediate', learned:false, rev:0},
        // Time & Place
        {word:'only', trans:'—Ç–æ–ª—å–∫–æ', ex:'I have <em>only</em> one.', deck:'basic', learned:false, rev:0},
        {word:'for now', trans:'–ø–æ–∫–∞ —á—Ç–æ', ex:'This is enough <em>for now</em>.', deck:'intermediate', learned:false, rev:0},
        {word:'later', trans:'–ø–æ–∑–∂–µ', ex:'See you <em>later</em>.', deck:'basic', learned:false, rev:0},
        {word:'before', trans:'–¥–æ, –ø–µ—Ä–µ–¥', ex:'Think <em>before</em> you speak.', deck:'basic', learned:false, rev:0},
        {word:'after', trans:'–ø–æ—Å–ª–µ', ex:'Let\'s meet <em>after</em> work.', deck:'basic', learned:false, rev:0},
        {word:'to the right', trans:'–Ω–∞–ø—Ä–∞–≤–æ', ex:'Turn <em>to the right</em>.', deck:'basic', learned:false, rev:0},
        {word:'to the left', trans:'–Ω–∞–ª–µ–≤–æ', ex:'Go <em>to the left</em>.', deck:'basic', learned:false, rev:0},
        {word:'today', trans:'—Å–µ–≥–æ–¥–Ω—è', ex:'I\'m busy <em>today</em>.', deck:'basic', learned:false, rev:0},
        {word:'tomorrow', trans:'–∑–∞–≤—Ç—Ä–∞', ex:'See you <em>tomorrow</em>.', deck:'basic', learned:false, rev:0},
        {word:'yesterday', trans:'–≤—á–µ—Ä–∞', ex:'I saw him <em>yesterday</em>.', deck:'basic', learned:false, rev:0},
        {word:'a lot', trans:'–º–Ω–æ–≥–æ', ex:'I have <em>a lot</em> of work.', deck:'basic', learned:false, rev:0},
        {word:'a little', trans:'–Ω–µ–º–Ω–æ–≥–æ', ex:'Just <em>a little</em>, please.', deck:'basic', learned:false, rev:0},
        {word:'then', trans:'–∑–∞—Ç–µ–º, —Ç–æ–≥–¥–∞', ex:'We had dinner, <em>then</em> watched a movie.', deck:'basic', learned:false, rev:0},
        {word:'unfortunately', trans:'–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é', ex:'<em>Unfortunately</em>, I can\'t come.', deck:'intermediate', learned:false, rev:0},
        {word:'everything', trans:'–≤—Å—ë', ex:'<em>Everything</em> is fine.', deck:'basic', learned:false, rev:0},
        {word:'nothing', trans:'–Ω–∏—á–µ–≥–æ', ex:'I have <em>nothing</em> to say.', deck:'basic', learned:false, rev:0},
        {word:'more', trans:'–±–æ–ª—å—à–µ, –µ—â—ë', ex:'I need <em>more</em> time.', deck:'basic', learned:false, rev:0},
        {word:'another', trans:'–¥—Ä—É–≥–æ–π', ex:'Give me <em>another</em> chance.', deck:'basic', learned:false, rev:0},
        {word:'the rest', trans:'–æ—Å—Ç–∞–ª—å–Ω–æ–µ', ex:'I\'ll do <em>the rest</em>.', deck:'intermediate', learned:false, rev:0},
        {word:'together', trans:'–≤–º–µ—Å—Ç–µ', ex:'Let\'s go <em>together</em>.', deck:'basic', learned:false, rev:0},
        {word:'separately', trans:'–æ—Ç–¥–µ–ª—å–Ω–æ', ex:'We paid <em>separately</em>.', deck:'intermediate', learned:false, rev:0},
        // Adjectives
        {word:'big', trans:'–±–æ–ª—å—à–æ–π', ex:'It\'s a <em>big</em> house.', deck:'basic', learned:false, rev:0},
        {word:'medium', trans:'—Å—Ä–µ–¥–Ω–∏–π', ex:'I\'d like a <em>medium</em> coffee.', deck:'basic', learned:false, rev:0},
        {word:'small', trans:'–º–∞–ª–µ–Ω—å–∫–∏–π', ex:'This is too <em>small</em>.', deck:'basic', learned:false, rev:0},
        {word:'other', trans:'–¥—Ä—É–≥–æ–π', ex:'The <em>other</em> day I saw him.', deck:'basic', learned:false, rev:0},
        {word:'same', trans:'—Ç–∞–∫–æ–π –∂–µ', ex:'We have the <em>same</em> phone.', deck:'basic', learned:false, rev:0},
        {word:'open', trans:'–æ—Ç–∫—Ä—ã—Ç—ã–π', ex:'The door is <em>open</em>.', deck:'basic', learned:false, rev:0},
        {word:'closed', trans:'–∑–∞–∫—Ä—ã—Ç—ã–π', ex:'The shop is <em>closed</em>.', deck:'basic', learned:false, rev:0},
        {word:'far', trans:'–¥–∞–ª–µ–∫–æ', ex:'It\'s too <em>far</em> to walk.', deck:'basic', learned:false, rev:0},
        {word:'near', trans:'–±–ª–∏–∑–∫–æ', ex:'The station is <em>near</em>.', deck:'basic', learned:false, rev:0},
        {word:'first', trans:'–ø–µ—Ä–≤—ã–π', ex:'This is my <em>first</em> time.', deck:'basic', learned:false, rev:0},
        {word:'last', trans:'–ø–æ—Å–ª–µ–¥–Ω–∏–π', ex:'It\'s the <em>last</em> chance.', deck:'basic', learned:false, rev:0},
        {word:'next', trans:'—Å–ª–µ–¥—É—é—â–∏–π', ex:'See you <em>next</em> week.', deck:'basic', learned:false, rev:0},
        {word:'previous', trans:'–ø—Ä–µ–¥—ã–¥—É—â–∏–π', ex:'Check the <em>previous</em> page.', deck:'intermediate', learned:false, rev:0},
        {word:'drunk', trans:'–ø—å—è–Ω—ã–π', ex:'He was <em>drunk</em> last night.', deck:'intermediate', learned:false, rev:0},
        {word:'sober', trans:'—Ç—Ä–µ–∑–≤—ã–π', ex:'I\'m completely <em>sober</em>.', deck:'intermediate', learned:false, rev:0}
    ];
    
    const $=id=>document.getElementById(id);
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    function save(){
        const data = JSON.stringify(S);
        // –õ–æ–∫–∞–ª—å–Ω–æ –≤—Å–µ–≥–¥–∞
        try { localStorage.setItem('wordly', data); } catch(e){}
        
        // –í –æ–±–ª–∞–∫–æ Telegram
        if(cloud){
            cloud.setItem('wordly_data', data, (err)=>{});
        }
        // –ò–ª–∏ –≤ DeviceStorage
        if(device && !cloud){
            device.setItem('wordly_data', data, (err)=>{});
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞
    function load(){
        // –ü—Ä–æ–±—É–µ–º CloudStorage
        if(cloud){
            cloud.getItem('wordly_data', (err, value)=>{
                if(!err && value){
                    try { Object.assign(S, JSON.parse(value)); update(); return; } catch(e){}
                }
                loadLocal();
            });
        // –ü—Ä–æ–±—É–µ–º DeviceStorage
        } else if(device){
            device.getItem('wordly_data', (err, value)=>{
                if(!err && value){
                    try { Object.assign(S, JSON.parse(value)); update(); return; } catch(e){}
                }
                loadLocal();
            });
        } else {
            loadLocal();
        }
    }
    
    // –õ–æ–∫–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞–∫ —Ñ–æ–ª–ª–±—ç–∫
    function loadLocal(){
        const d = localStorage.getItem('wordly');
        if(d){
            try {
                Object.assign(S, JSON.parse(d));
            } catch(e){}
        } else {
            S.words = [...samples];
            S.startDate = new Date().toISOString();
        }
        update();
    }
    const byDeck=k=>S.words.filter(w=>w.deck===k);
    const study=()=>{
        let words;
        if(S.deck){
            words = S.words.filter(w=>w.deck===S.deck);
        } else {
            words = S.words;
        }
        // –í —Ä–µ–∂–∏–º–µ 'learn' ‚Äî —Ç–æ–ª—å–∫–æ –Ω–µ–≤—ã—É—á–µ–Ω–Ω—ã–µ, –≤ 'repeat' ‚Äî –≤—Å–µ
        if(S.mode === 'learn'){
            words = words.filter(w=>!w.learned);
        }
        return words;
    };
    const todayKey=()=>new Date().toISOString().split('T')[0];
    
    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ (Fisher-Yates)
    function shuffle(arr){
        const a = [...arr];
        for(let i = a.length - 1; i > 0; i--){
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }
    
    // –¢–µ–∫—É—â–∞—è –ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω–∞—è –∫–æ–ª–æ–¥–∞
    let shuffledCards = [];
    let shuffleIdx = 0;
    
    function reshuffleCards(){
        shuffledCards = shuffle(study());
        shuffleIdx = 0;
    }
    
    function update(){
        const t=S.words.length, l=S.words.filter(w=>w.learned).length;
        const remaining = study().length;
        $('remaining').textContent = remaining;
        renderDecks();
        showCard();
        updateProgress();
    }
    
    function updateProgress(){
        const t=S.words.length, l=S.words.filter(w=>w.learned).length;
        const p=t?Math.round(l/t*100):0;
        
        $('p-pct').textContent=p+'%';
        $('p-fill').style.width=p+'%';
        $('p-total').textContent=t;
        $('p-learned').textContent=l;
        $('p-today').textContent=S.today;
        $('p-streak').textContent=S.streak+' –¥–Ω–µ–π';
        
        const days = Object.keys(S.dailyStats).length || 1;
        const totalL = Object.values(S.dailyStats).reduce((a,b)=>a+(b.learned||0),0);
        $('p-avg').textContent = Math.round(totalL / days);
        
        renderWeekChart();
    }
    
    function renderWeekChart(){
        const c = $('week-chart');
        c.innerHTML = '';
        const days = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
        const today = new Date();
        const data = [];
        
        for(let i=6; i>=0; i--){
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const key = d.toISOString().split('T')[0];
            const dayIdx = d.getDay() === 0 ? 6 : d.getDay() - 1;
            data.push({
                name: days[dayIdx],
                count: S.dailyStats[key]?.learned || 0,
                isToday: i === 0
            });
        }
        
        const max = Math.max(...data.map(d=>d.count), 1);
        
        data.forEach(d=>{
            const pct = (d.count / max) * 100;
            const div = document.createElement('div');
            div.className = 'week-day';
            div.innerHTML = `
                <div class="week-bar-wrap">
                    <div class="week-bar ${d.isToday?'today':''}" style="height:${Math.max(pct,4)}%"></div>
                </div>
                <span class="week-lbl ${d.isToday?'today':''}">${d.name}</span>
            `;
            c.appendChild(div);
        });
    }
    
    function renderDecks(){
        const c=$('decks'); c.innerHTML='';
        Object.entries(S.decks).forEach(([k,d])=>{
            const ws=byDeck(k), l=ws.filter(w=>w.learned).length;
            const el=document.createElement('div');
            el.className='deck';
            el.innerHTML=`<div class="deck-icon ${d.cls}">${d.icon}</div><div class="deck-info"><div class="deck-name">${d.name}</div><div class="deck-meta">${ws.length} —Å–ª–æ–≤ ¬∑ ${l} –≤—ã—É—á–µ–Ω–æ</div></div><div class="deck-arr">‚Ä∫</div>`;
            el.onclick=()=>openDeck(k);
            c.appendChild(el);
        });
    }
    
    let editingWordIdx = null;
    
    function openDeck(k){
        haptic(); S.deck=k;
        $('decks-list').style.display='none';
        $('deck-detail').style.display='block';
        $('d-title').textContent=S.decks[k].name;
        const c=$('words'); c.innerHTML='';
        const ws=byDeck(k);
        if(!ws.length){ c.innerHTML='<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-text">–ü—É—Å—Ç–æ</div><div class="empty-sub">–î–æ–±–∞–≤—å —Å–ª–æ–≤–∞</div></div>'; return; }
        ws.forEach((w,i)=>{
            const st=w.learned?'learned':w.rev>0?'learning':'';
            const el=document.createElement('div');
            el.className='word-item';
            el.innerHTML=`<div><div class="word-w">${w.word}</div><div class="word-t">${w.trans}</div></div><div class="word-status ${st}"></div>`;
            el.onclick=()=>openEditModal(w);
            c.appendChild(el);
        });
    }
    
    function openEditModal(w){
        haptic();
        editingWordIdx = S.words.indexOf(w);
        $('e-word').value = w.word || '';
        $('e-phon').value = w.phon || '';
        $('e-trans').value = w.trans || '';
        $('e-ex').value = w.ex || '';
        $('e-deck').value = w.deck || 'basic';
        $('edit-modal').classList.add('show');
    }
    
    function closeEditModal(){
        $('edit-modal').classList.remove('show');
        editingWordIdx = null;
    }
    
    $('edit-cancel')?.addEventListener('click', closeEditModal);
    
    $('edit-modal')?.addEventListener('click', (e)=>{
        if(e.target.id === 'edit-modal') closeEditModal();
    });
    
    $('edit-save')?.addEventListener('click', ()=>{
        if(editingWordIdx === null) return;
        const w = S.words[editingWordIdx];
        w.word = $('e-word').value.trim();
        w.phon = $('e-phon').value.trim();
        w.trans = $('e-trans').value.trim();
        w.ex = $('e-ex').value.trim();
        w.deck = $('e-deck').value;
        save();
        closeEditModal();
        if(S.deck) openDeck(S.deck);
        toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','ok');
    });
    
    $('edit-delete')?.addEventListener('click', ()=>{
        if(editingWordIdx === null) return;
        if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–ª–æ–≤–æ?')){
            S.words.splice(editingWordIdx, 1);
            save();
            closeEditModal();
            if(S.deck) openDeck(S.deck);
            reshuffleCards();
            update();
            toast('–£–¥–∞–ª–µ–Ω–æ','ok');
        }
    });
    
    function closeDeck(){ haptic(); $('decks-list').style.display='block'; $('deck-detail').style.display='none'; S.deck=null; }
    
    function showCard(){
        const ws = study();
        if(!ws.length){ 
            if(S.mode === 'learn'){
                $('c-word').textContent='–í—Å—ë –≤—ã—É—á–µ–Ω–æ! üéâ'; 
                $('c-trans').textContent='–ü–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ';
            } else {
                $('c-word').textContent='–ù–µ—Ç —Å–ª–æ–≤'; 
                $('c-trans').textContent='–î–æ–±–∞–≤—å –Ω–æ–≤—ã–µ';
            }
            $('c-phon').textContent=''; 
            $('c-cat').textContent='‚Äî'; 
            $('c-ex').textContent='';
            shuffledCards = [];
            return; 
        }
        
        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if(shuffledCards.length === 0 || shuffleIdx >= shuffledCards.length){
            reshuffleCards();
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–µ–∫—É—â–∞—è –∫–∞—Ä—Ç–∞ –µ—â—ë –≤–∞–ª–∏–¥–Ω–∞
        const currentCard = shuffledCards[shuffleIdx];
        if(!currentCard || (S.mode === 'learn' && currentCard.learned)){
            reshuffleCards();
        }
        
        if(shuffledCards.length === 0) return;
        
        const w = shuffledCards[shuffleIdx];
        $('c-word').textContent=w.word;
        $('c-phon').textContent=w.phon||'';
        $('c-cat').textContent=S.decks[w.deck]?.name||'‚Äî';
        $('c-trans').textContent=w.trans;
        $('c-ex').innerHTML=w.ex||'';
        $('card').classList.remove('flipped');
    }
    
    function next(){ 
        shuffleIdx++;
        if(shuffleIdx >= shuffledCards.length){
            reshuffleCards();
        }
        showCard(); 
    }
    
    function cur(){ 
        return shuffledCards.length ? shuffledCards[shuffleIdx] : null; 
    }
    
    $('card').onclick=function(){ this.classList.toggle('flipped'); haptic(); };
    
    $('b-yes').onclick=()=>{
        const w=cur(); if(!w)return;
        haptic('ok');
        const i=S.words.findIndex(x=>x.word===w.word&&x.deck===w.deck);
        if(i>=0){ S.words[i].learned=true; S.words[i].rev++; }
        S.today++;
        const key = todayKey();
        if(!S.dailyStats[key]) S.dailyStats[key] = {learned:0};
        S.dailyStats[key].learned++;
        save(); next(); update();
        toast('–û—Ç–ª–∏—á–Ω–æ! ‚úì','ok');
    };
    
    $('b-no').onclick=()=>{
        const w=cur(); if(!w)return;
        haptic('err');
        const i=S.words.findIndex(x=>x.word===w.word&&x.deck===w.deck);
        if(i>=0) S.words[i].rev++;
        save(); next();
        toast('–ü–æ–≤—Ç–æ—Ä–∏–º','err');
    };
    
    $('b-skip').onclick=()=>{ haptic(); next(); };
    $('back').onclick=closeDeck;
    $('study').onclick=()=>{ haptic('ok'); document.querySelector('[data-v="home"]').click(); toast(`–£—á–∏–º: ${S.decks[S.deck].name}`,'ok'); };
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
    $('mode-learn').onclick=()=>{
        haptic();
        S.mode = 'learn';
        reshuffleCards();
        $('mode-learn').classList.add('on');
        $('mode-repeat').classList.remove('on');
        update();
    };
    $('mode-repeat').onclick=()=>{
        haptic();
        S.mode = 'repeat';
        reshuffleCards();
        $('mode-repeat').classList.add('on');
        $('mode-learn').classList.remove('on');
        update();
    };
    
    document.querySelectorAll('.nav-item').forEach(n=>{
        n.onclick=()=>{
            haptic();
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('on'));
            n.classList.add('on');
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
            $('v-'+n.dataset.v).classList.add('on');
            if(n.dataset.v!=='decks') closeDeck();
        };
    });
    
    $('add-btn').onclick=()=>{
        const word=$('i-word').value.trim(), trans=$('i-trans').value.trim();
        if(!word||!trans){ haptic('err'); toast('–ó–∞–ø–æ–ª–Ω–∏ —Å–ª–æ–≤–æ –∏ –ø–µ—Ä–µ–≤–æ–¥','err'); return; }
        S.words.push({word, phon:$('i-phon').value.trim(), trans, ex:$('i-ex').value.trim().replace(new RegExp(word,'gi'),`<em>${word}</em>`), deck:$('i-deck').value, learned:false, rev:0});
        save(); update();
        ['i-word','i-phon','i-trans','i-ex'].forEach(id=>$(id).value='');
        haptic('ok'); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ! ‚úì','ok');
    };
    
    document.querySelectorAll('.toggle').forEach(t=>t.onclick=()=>{ haptic(); t.classList.toggle('on'); });
    document.querySelectorAll('.cnt-btn[data-n]').forEach(b=>b.onclick=()=>{ haptic(); document.querySelectorAll('.cnt-btn[data-n]').forEach(x=>x.classList.remove('on')); b.classList.add('on'); });
    
    $('export')?.addEventListener('click',()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(S,null,2)])); a.download='wordly.json'; a.click(); toast('–≠–∫—Å–ø–æ—Ä—Ç','ok'); });
    
    // –ò–º–ø–æ—Ä—Ç JSON
    $('import')?.addEventListener('click',()=>{ $('import-file').click(); });
    $('import-file')?.addEventListener('change',(e)=>{
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev)=>{
            try {
                const data = JSON.parse(ev.target.result);
                if(data.words && Array.isArray(data.words)){
                    // –ú–µ—Ä–∂–∏–º —Å–ª–æ–≤–∞
                    const existingWords = new Set(S.words.map(w=>w.word.toLowerCase()));
                    let added = 0;
                    data.words.forEach(w=>{
                        if(!existingWords.has(w.word.toLowerCase())){
                            S.words.push(w);
                            added++;
                        }
                    });
                    // –ú–µ—Ä–∂–∏–º –∫–æ–ª–æ–¥—ã
                    if(data.decks){
                        Object.assign(S.decks, data.decks);
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                    const dataStr = JSON.stringify(S);
                    try { localStorage.setItem('wordly', dataStr); } catch(e){}
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ –Ω–∞–ø—Ä—è–º—É—é
                    if(cloud){
                        cloud.setItem('wordly_data', dataStr, (err)=>{
                            if(!err){
                                toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${added} —Å–ª–æ–≤ ‚òÅÔ∏è`,'ok');
                            } else {
                                toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${added} —Å–ª–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ)`,'ok');
                            }
                        });
                    } else {
                        toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${added} —Å–ª–æ–≤`,'ok');
                    }
                    
                    reshuffleCards();
                    update();
                } else {
                    toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç','err');
                }
            } catch(err){
                toast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è','err');
            }
        };
        reader.readAsText(file);
        e.target.value = '';
    });
    $('reset')?.addEventListener('click',()=>{ 
        if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')){ 
            localStorage.removeItem('wordly'); 
            if(cloud) cloud.removeItem('wordly_data', ()=>{});
            location.reload(); 
        }
    });
    // –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ
    $('sync-up')?.addEventListener('click',()=>{
        haptic();
        if(cloud){
            save();
            toast('–í—ã–≥—Ä—É–∂–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ ‚òÅÔ∏è‚Üë','ok');
        } else if(device){
            save();
            toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ üì±','ok');
        } else {
            toast('–û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram','err');
        }
    });
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
    $('sync-down')?.addEventListener('click',()=>{
        haptic();
        if(cloud){
            cloud.getItem('wordly_data', (err, value)=>{
                if(!err && value){
                    try {
                        Object.assign(S, JSON.parse(value));
                        save(); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Ç–æ–∂–µ
                        reshuffleCards();
                        update();
                        toast('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞ ‚òÅÔ∏è‚Üì','ok');
                    } catch(e){
                        toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','err');
                    }
                } else {
                    toast('–í –æ–±–ª–∞–∫–µ –ø—É—Å—Ç–æ','err');
                }
            });
        } else if(device){
            device.getItem('wordly_data', (err, value)=>{
                if(!err && value){
                    try {
                        Object.assign(S, JSON.parse(value));
                        reshuffleCards();
                        update();
                        toast('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ üì±','ok');
                    } catch(e){
                        toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','err');
                    }
                } else {
                    toast('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö','err');
                }
            });
        } else {
            toast('–û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram','err');
        }
    });
    
    // –î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
    $('add-home')?.addEventListener('click',()=>{
        haptic();
        if(tg?.addToHomeScreen){
            tg.addToHomeScreen();
        } else {
            toast('–û–±–Ω–æ–≤–∏—Ç–µ Telegram','err');
        }
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    if(tg?.checkHomeScreenStatus){
        tg.checkHomeScreenStatus(function(status){
            const btn = $('add-home');
            if(btn){
                if(status === 'added'){
                    btn.textContent = '‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ';
                    btn.disabled = true;
                } else if(status === 'unsupported'){
                    btn.textContent = '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                    btn.disabled = true;
                }
            }
        });
    }
    
    function toast(m,t='ok'){ const el=$('toast'); el.textContent=m; el.className=`toast ${t} show`; setTimeout(()=>el.classList.remove('show'),2500); }
    
    load();
    </script>
</body>
</html>
